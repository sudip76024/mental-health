<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidential Counseling & Admin Insights</title>
    <!-- Tailwind CSS CDN for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font for a clean, modern look -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray */
        }
        .tab-button.active {
            border-bottom: 3px solid #10B981; /* Emerald-500 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header Section -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                <i class="fas fa-hand-holding-heart text-emerald-500 mr-2"></i>
                <span class="hidden sm:inline">Mindful Connect</span>
            </h1>
            <nav class="flex space-x-4">
                <button id="userTab" class="tab-button text-gray-600 hover:text-emerald-500 font-medium transition-colors duration-300 pb-2 active">User</button>
                <button id="adminTab" class="tab-button text-gray-600 hover:text-emerald-500 font-medium transition-colors duration-300 pb-2">Admin</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 md:py-12">

        <!-- User View -->
        <section id="user-view" class="view">
            <div class="bg-white p-6 md:p-10 rounded-xl shadow-lg">
                <div class="max-w-3xl mx-auto text-center">
                    <h2 class="text-3xl md:text-4xl font-bold text-emerald-600 mb-4">Confidential Counseling</h2>
                    <p class="text-lg text-gray-600 mb-6">
                        Book a session anonymously. Your privacy is our priority.
                    </p>
                    <p class="text-gray-500 mb-8">
                        Your unique booking ID: <code id="userIdDisplay" class="font-mono bg-gray-100 px-2 py-1 rounded-md text-sm">Loading...</code>
                    </p>
                    
                    <div id="bookingForm" class="space-y-6">
                        <div>
                            <label for="topic" class="block text-left text-sm font-medium text-gray-700">Topic of Session</label>
                            <input type="text" id="topic" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm" placeholder="e.g., stress, anxiety, relationships">
                        </div>
                        <div>
                            <label for="time" class="block text-left text-sm font-medium text-gray-700">Preferred Time</label>
                            <input type="datetime-local" id="time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm">
                        </div>
                        <button id="bookSessionBtn" class="w-full bg-emerald-600 text-white font-semibold py-3 px-8 rounded-full hover:bg-emerald-700 transition-colors duration-300 shadow-md">
                            Book Session
                        </button>
                    </div>
                    
                    <div id="bookingSuccess" class="hidden mt-6 bg-emerald-100 border border-emerald-400 text-emerald-700 p-4 rounded-md">
                        <p class="font-bold text-lg">Booking Confirmed!</p>
                        <p>A counselor will reach out to you using your anonymous ID. Please keep it safe.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Admin View -->
        <section id="admin-view" class="view hidden">
            <div class="bg-white p-6 md:p-10 rounded-xl shadow-lg">
                <div class="max-w-3xl mx-auto text-center">
                    <h2 class="text-3xl md:text-4xl font-bold text-emerald-600 mb-6">Admin Insights</h2>
                    <p class="text-lg text-gray-600 mb-8">
                        Aggregate data dashboards for policy-making.
                    </p>

                    <!-- Aggregate Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div class="bg-gray-100 p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold text-gray-900">Total Bookings</h3>
                            <p id="totalBookings" class="text-4xl font-bold text-emerald-600 mt-2">0</p>
                        </div>
                        <div class="bg-gray-100 p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold text-gray-900">Top Topic</h3>
                            <p id="topTopic" class="text-3xl font-bold text-emerald-600 mt-2">N/A</p>
                        </div>
                    </div>

                    <!-- Session List -->
                    <div class="text-left">
                        <h3 class="text-2xl font-bold text-emerald-600 mb-4">Recent Sessions</h3>
                        <div id="sessionList" class="space-y-4">
                            <p class="text-center text-gray-500">No sessions booked yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <!-- Footer Section -->
    <footer class="bg-gray-900 text-gray-300 py-8 text-center mt-8">
        <div class="container mx-auto px-4">
            <p>&copy; 2025 Mindful Connect. All Rights Reserved.</p>
            <p class="text-sm mt-2 text-gray-400">
                Data is simulated for demonstration purposes. This is not a real service.
            </p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase global variables are provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth ---
        let app, db, auth;
        let userId = null;

        const initFirebase = async () => {
            try {
                setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using custom token or anonymously if token is not available
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        setupListeners();
                    } else {
                        userId = crypto.randomUUID();
                        document.getElementById('userIdDisplay').textContent = userId;
                        setupListeners();
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };

        // --- UI Elements and Event Listeners ---
        const userTab = document.getElementById('userTab');
        const adminTab = document.getElementById('adminTab');
        const userView = document.getElementById('user-view');
        const adminView = document.getElementById('admin-view');
        const bookSessionBtn = document.getElementById('bookSessionBtn');
        const bookingSuccess = document.getElementById('bookingSuccess');
        const topicInput = document.getElementById('topic');
        const timeInput = document.getElementById('time');
        const totalBookingsDisplay = document.getElementById('totalBookings');
        const topTopicDisplay = document.getElementById('topTopic');
        const sessionList = document.getElementById('sessionList');

        // Tab switching logic
        userTab.addEventListener('click', () => {
            userTab.classList.add('active');
            adminTab.classList.remove('active');
            userView.classList.remove('hidden');
            adminView.classList.add('hidden');
        });

        adminTab.addEventListener('click', () => {
            adminTab.classList.add('active');
            userTab.classList.remove('active');
            adminView.classList.remove('hidden');
            userView.classList.add('hidden');
        });

        // Booking submission logic
        bookSessionBtn.addEventListener('click', async () => {
            if (!db || !userId) {
                console.error("Firebase not initialized or user not authenticated.");
                return;
            }

            const topic = topicInput.value;
            const time = timeInput.value;

            if (!topic || !time) {
                console.warn("Please fill in all fields.");
                return;
            }

            try {
                const bookingData = {
                    userId: userId,
                    topic: topic,
                    time: new Date(time).toISOString(),
                    timestamp: new Date().toISOString()
                };
                
                // Store in a public collection
                await addDoc(collection(db, `artifacts/${appId}/public/data/counseling_sessions`), bookingData);
                console.log("Session booked successfully:", bookingData);
                
                topicInput.value = '';
                timeInput.value = '';
                bookingSuccess.classList.remove('hidden');

                // Auto-hide success message after 5 seconds
                setTimeout(() => {
                    bookingSuccess.classList.add('hidden');
                }, 5000);

            } catch (error) {
                console.error("Error booking session:", error);
            }
        });

        // --- Firestore Real-time Listener and UI Update ---
        function setupListeners() {
            if (!db) {
                console.error("Firestore is not available.");
                return;
            }

            const sessionsRef = collection(db, `artifacts/${appId}/public/data/counseling_sessions`);
            const sessionsQuery = query(sessionsRef);
            
            onSnapshot(sessionsQuery, (snapshot) => {
                const sessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderAdminDashboard(sessions);

            }, (error) => {
                console.error("Error fetching sessions:", error);
            });
        }

        function renderAdminDashboard(sessions) {
            // Update aggregate metrics
            totalBookingsDisplay.textContent = sessions.length;

            const topics = sessions.map(session => session.topic);
            const topicCounts = topics.reduce((acc, topic) => {
                acc[topic] = (acc[topic] || 0) + 1;
                return acc;
            }, {});
            const topTopic = Object.keys(topicCounts).sort((a, b) => topicCounts[b] - topicCounts[a])[0];
            topTopicDisplay.textContent = topTopic || 'N/A';

            // Update session list
            sessionList.innerHTML = '';
            if (sessions.length === 0) {
                sessionList.innerHTML = '<p class="text-center text-gray-500">No sessions booked yet.</p>';
                return;
            }

            // Sort entries by timestamp in descending order on the client-side
            sessions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = `p-4 rounded-lg shadow-sm border border-gray-200 bg-gray-100`;
                sessionDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-bold text-lg">${session.topic}</span>
                        <span class="text-xs text-gray-500">${new Date(session.time).toLocaleString()}</span>
                    </div>
                    <p class="text-sm text-gray-500">User ID: <code class="font-mono">${session.userId}</code></p>
                `;
                sessionList.appendChild(sessionDiv);
            });
        }
        
        // Start the application
        window.onload = initFirebase;
    </script>
</body>
</html>
